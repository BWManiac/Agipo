# Diary Entry 17.2: Connection Tool Schema Fix

**Date:** 2025-12-04  
**Task:** N/A  
**Status:** âœ… Complete

---

## 1. Context

After fixing the tool ID mismatch (Entry 17.1), we discovered agents could load tools but couldn't use them **with parameters**. This entry documents:

1. **The symptom:** Agent said "I can only fetch all of your emails" despite `GMAIL_FETCH_EMAILS` supporting `maxResults`, `query`, etc. The `GMAIL_SEND_EMAIL` tool couldn't specify recipient, subject, or body.

2. **Root cause:** We were accessing `composioTool.parameters` when the actual schema lives at `composioTool.function.parameters`.

3. **The fix:** Updated `getConnectionToolExecutable()` to access the correct property path.

**Key Learning:** The Composio SDK's `tools.get()` returns an OpenAI-style tool definition with the schema nested under `function.parameters`, not at the top level.

---

## 2. Implementation Summary

### Files Modified

| File | Action | Purpose | Lines |
|------|--------|---------|-------|
| `app/api/tools/services/runtime.ts` | Modify | Fixed schema extraction in `getConnectionToolExecutable()` | ~10 |

### The Problem: Tools Execute But Can't Accept Parameters

**What Users Saw:**
- Agent said "I can only fetch all of your emails" (couldn't specify `maxResults: 20`)
- `GMAIL_SEND_EMAIL` couldn't specify recipient, subject, or body

**Server Logs Revealed Empty Schemas:**
```
[Runtime] Loading connection tool: GMAIL_FETCH_EMAILS
[Runtime] Converting schema - properties: none, required: none
[Runtime] Empty schema generated, using passthrough
```

The tools loaded successfully, but with **empty parameter schemas**. The AI model couldn't see what parameters were available.

---

## 3. Key Decisions

| Decision | Choice | Rationale |
|----------|--------|-----------|
| Schema Path | `tool.function.parameters` | Composio SDK returns OpenAI-compatible format |
| Fallback | Check both paths | Future compatibility if Composio changes format |

---

## 4. Technical Deep Dive

### The Composio SDK Tool Structure

When you call `client.tools.get(userId, { tools: ['GMAIL_SEND_EMAIL'] })`, Composio returns an **OpenAI-compatible tool definition**:

```json
{
  "type": "function",
  "function": {
    "name": "GMAIL_SEND_EMAIL",
    "description": "Sends an email via Gmail API...",
    "parameters": {
      "type": "object",
      "properties": {
        "recipient_email": { "type": "string", "description": "Primary recipient's email address" },
        "subject": { "type": "string", "description": "Email subject line" },
        "body": { "type": "string", "description": "Email content" }
      },
      "required": ["recipient_email"]
    }
  }
}
```

**Critical insight:** The parameter schema is at `tool.function.parameters`, NOT `tool.parameters`.

### The Fix

**Before:**
```typescript
const parameters = (composioTool as { parameters?: Record<string, unknown> }).parameters || {};
```

**After:**
```typescript
type ComposioToolShape = {
  function?: { parameters?: Record<string, unknown> };
  parameters?: Record<string, unknown>;
};
const typedTool = composioTool as ComposioToolShape;
const parameters = typedTool.function?.parameters || typedTool.parameters || {};
```

---

## 5. Lessons Learned

- **Composio SDK structure:** `tools.get()` returns OpenAI-compatible format with schema at `function.parameters`
- **Debugging schema issues:** Check what the SDK actually returns, not what you assume
- **Multiple code paths:** When fixing SDK integration issues, search for all usages

---

## 6. Next Steps

- [ ] Better error handling when tool execution fails
- [ ] Show tool execution status in chat UI
- [ ] Add more integration types beyond Gmail

---

## References

- **Related Diary:** `17-ConnectionToolsIntegration.md` - Initial implementation
- **Related Diary:** `17.1-ConnectionToolExecutionFix.md` - Tool ID fix

---

**Last Updated:** 2025-12-04
