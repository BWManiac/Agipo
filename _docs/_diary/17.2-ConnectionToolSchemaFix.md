# Diary Entry 17.2: Connection Tool Schema Fix

**Date:** December 4, 2025  
**Topic:** Fixing Empty Parameter Schemas in Composio Tool Loading  
**Status:** Complete

---

## 1. Executive Summary

After fixing the tool ID mismatch (Entry 17.1), we discovered agents could load tools but couldn't use them **with parameters**. This entry documents:

1. **The symptom:** Agent said "I can only fetch all of your emails" despite `GMAIL_FETCH_EMAILS` supporting `maxResults`, `query`, etc. The `GMAIL_SEND_EMAIL` tool couldn't specify recipient, subject, or body.

2. **Root cause:** Two separate code paths for loading Composio tools - we fixed one but missed the other. Both were accessing `composioTool.parameters` when the actual schema lives at `composioTool.function.parameters`.

3. **The fix:** Updated `getConnectionToolExecutable()` to access the correct property path.

**Key Learning:** The Composio SDK's `tools.get()` returns an OpenAI-style tool definition with the schema nested under `function.parameters`, not at the top level.

---

## 2. The Problem: Tools Execute But Can't Accept Parameters

### 2.1 What Users Saw

**Chat Interaction:**
```
USER: Summarize the last 20 emails and send a report to jacob@rocketmail.com

MIRA PATEL: I am unable to summarize emails. I can only fetch all of your 
emails. Would you like me to do that?

USER: sure

MIRA PATEL: I found 201 emails. The most recent one is from ASUS...
[Only fetched default amount, couldn't specify maxResults: 20]

USER: ok keep going

MIRA PATEL: I apologize for the repeated errors. The GMAIL_CREATE_EMAIL_DRAFT 
tool is not allowing me to add a recipient to the draft... I am blocked by 
this technical limitation.
```

### 2.2 Server Logs Revealed Empty Schemas

```
[Runtime] Loading connection tool: GMAIL_FETCH_EMAILS for connection: ca_wudNUwXqrbtx
[Runtime] Converting schema - properties: none, required: none
[Runtime] Empty schema generated, using passthrough
[Runtime] Successfully loaded connection tool: GMAIL_FETCH_EMAILS
```

The tools loaded successfully, but with **empty parameter schemas**. The AI model couldn't see what parameters were available.

### 2.3 The Impact

| Tool | Expected Parameters | What AI Could See |
|------|--------------------|--------------------|
| `GMAIL_FETCH_EMAILS` | `maxResults`, `query`, `labelIds`, `includeSpamTrash` | (nothing) |
| `GMAIL_SEND_EMAIL` | `recipient_email`, `subject`, `body`, `cc`, `bcc` | (nothing) |
| `GMAIL_CREATE_EMAIL_DRAFT` | `recipient_email`, `subject`, `body` | (nothing) |

Without parameter schemas, the AI executed tools with defaults or failed when required parameters were missing.

---

## 3. Root Cause Analysis

### 3.1 The Composio SDK Tool Structure

When you call `client.tools.get(userId, { tools: ['GMAIL_SEND_EMAIL'] })`, Composio returns an **OpenAI-compatible tool definition**:

```json
{
  "type": "function",
  "function": {
    "name": "GMAIL_SEND_EMAIL",
    "description": "Sends an email via Gmail API...",
    "parameters": {
      "type": "object",
      "properties": {
        "recipient_email": {
          "type": "string",
          "description": "Primary recipient's email address"
        },
        "subject": {
          "type": "string", 
          "description": "Email subject line"
        },
        "body": {
          "type": "string",
          "description": "Email content (plain text or HTML)"
        }
      },
      "required": ["recipient_email"]
    }
  }
}
```

**Critical insight:** The parameter schema is at `tool.function.parameters`, NOT `tool.parameters`.

### 3.2 Two Code Paths, One Bug Fixed

Our codebase had **two separate functions** for loading Composio tools:

| Function | Used By | Purpose |
|----------|---------|---------|
| `convertComposioToolToDefinition()` | `getExecutableToolById()` | Load standalone Composio tools (prefixed with `composio-`) |
| `getConnectionToolExecutable()` | Chat route | Load connection-bound tools from `connectionToolBindings` |

We fixed `convertComposioToolToDefinition()` but the chat route uses `getConnectionToolExecutable()`.

### 3.3 The Buggy Code

**In `getConnectionToolExecutable()` (line 320):**

```typescript
// BEFORE (BUGGY):
const parameters = (composioTool as { parameters?: Record<string, unknown> }).parameters || {};
```

This looked for `composioTool.parameters` which doesn't exist - the schema is at `composioTool.function.parameters`.

**Result:** `parameters` was always `{}`, leading to empty Zod schemas.

---

## 4. The Fix

### 4.1 Code Change

**File:** `app/api/tools/services/runtime.ts`

**Before:**
```typescript
// Extract schema from Composio tool
const parameters = (composioTool as { parameters?: Record<string, unknown> }).parameters || {};
const zodSchema = convertComposioSchemaToZod(parameters);
```

**After:**
```typescript
// Extract schema from Composio tool
// Composio SDK returns { type: "function", function: { parameters: {...} } }
type ComposioToolShape = {
  function?: { parameters?: Record<string, unknown> };
  parameters?: Record<string, unknown>;
};
const typedTool = composioTool as ComposioToolShape;
const parameters = typedTool.function?.parameters || typedTool.parameters || {};
const zodSchema = convertComposioSchemaToZod(parameters);
```

### 4.2 Why Check Both Paths?

We check `typedTool.function?.parameters` first (OpenAI format from `tools.get()`), then fall back to `typedTool.parameters` for potential future compatibility if Composio changes their response format.

---

## 5. File Impact Analysis

| File | Change | Lines |
|------|--------|-------|
| `app/api/tools/services/runtime.ts` | Fixed schema extraction in `getConnectionToolExecutable()` | ~320-325 |

**Single file, surgical fix.** The same fix was already applied to `convertComposioToolToDefinition()` earlier.

---

## 6. Verification

### 6.1 Expected Server Logs (After Fix)

```
[Runtime] Loading connection tool: GMAIL_SEND_EMAIL for connection: ca_wudNUwXqrbtx
[Runtime] Converting schema - properties: attachment, bcc, body, cc, recipient_email, subject, required: recipient_email
[Runtime] Successfully loaded connection tool: GMAIL_SEND_EMAIL
```

Now the schema shows actual properties.

### 6.2 Expected Chat Behavior

```
USER: Fetch my last 20 emails and send a summary to jacob@rocketmail.com

MIRA PATEL: [Uses GMAIL_FETCH_EMAILS with maxResults: 20]
I've fetched your last 20 emails. Here's a summary...

[Uses GMAIL_SEND_EMAIL with recipient_email, subject, body]
I've sent the summary to jacob@rocketmail.com.
```

---

## 7. Key Learnings

### 7.1 Composio SDK Structure

The Composio SDK has **two different tool retrieval methods** with different return shapes:

| Method | Returns | Schema Location |
|--------|---------|-----------------|
| `client.tools.get(userId, filters)` | OpenAI-compatible tool | `tool.function.parameters` |
| `client.tools.getRawComposioTools(filters)` | Raw Composio format | `tool.inputParameters` |

When integrating with the Vercel AI SDK, `tools.get()` is the right choice because it returns the OpenAI function-calling format.

### 7.2 Debugging Schema Issues

When schemas appear empty:
1. Check what the SDK actually returns (not what you assume)
2. Log the raw response structure
3. Verify the property path matches

**Debug command that helped:**
```bash
node -e "
const { Composio } = require('@composio/core');
const client = new Composio();
client.tools.get('test', { tools: ['GMAIL_SEND_EMAIL'] })
  .then(tools => console.log(JSON.stringify(tools[0], null, 2)));
"
```

### 7.3 Multiple Code Paths

When fixing SDK integration issues, search for **all usages** of the SDK. We had two code paths loading Composio tools and only fixed one initially.

---

## 8. Related Entries

- **Entry 17:** Connection Tools Integration (7-stage implementation)
- **Entry 17.1:** Tool ID mismatch fix (`tool.name` → `tool.slug`)
- **Entry 15:** Composio Integrations Platform
- **Entry 16:** Clerk Authentication Integration

---

## 9. Remaining Work

The connection tools integration is now functionally complete. Agents can:
- ✅ See assigned connection tools in Capabilities
- ✅ Load tools with correct IDs
- ✅ Load tools with correct parameter schemas
- ✅ Execute tools with user-specified parameters
- ✅ Use the correct connected account (multi-account support)

**Next steps (optional improvements):**
- Better error handling when tool execution fails
- Show tool execution status in chat UI
- Add more integration types beyond Gmail

