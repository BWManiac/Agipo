# Diary Entry 17.1: Connection Tool Execution Fix

**Date:** 2025-12-04  
**Task:** N/A  
**Status:** ✅ Complete

---

## 1. Context

After implementing Connection Tools (Entry 17) and Clerk Auth (Entry 16), we discovered agents couldn't actually **use** the assigned connection tools in chat. This entry documents:

1. **The symptom:** Mira Patel said "I can't access your emails" despite having Gmail tools assigned in Capabilities.

2. **Root cause:** `getToolsForConnection()` used `tool.name` (display name: "Fetch emails") instead of `tool.slug` (action name: "GMAIL_FETCH_EMAILS") as the tool ID.

3. **The fix:** Changed `id: tool.name` → `id: tool.slug` and added `limit: 100`.

**Key Insight:** Composio tools have two identifiers: `name` (human-readable display name) and `slug` (machine-readable action name). The runtime expects the `slug` for execution, but we were storing the `name`.

---

## 2. Implementation Summary

### Files Modified

| File | Action | Purpose | Lines |
|------|--------|---------|-------|
| `app/api/connections/services/composio.ts` | Modify | Fixed `id: tool.slug`, added `limit: 100` | ~10 |
| `app/api/tools/chat/route.ts` | Modify | Updated model to `google/gemini-2.5-pro` | ~5 |
| `_tables/agents/mira-patel.ts` | Modify | Cleared invalid bindings, user re-added via UI | ~5 |

### The Problem: Tools Visible But Not Usable

**What Users Saw:**
- Capabilities Tab: Shows "Fetch emails" and "Create email draft" assigned ✓
- Chat: Agent said "I can't access your emails" ❌

**Root Cause:** The tools appeared in the UI, but the agent genuinely didn't have access to them during chat execution. The toolMap was empty because tool loading failed silently.

---

## 3. Key Decisions

| Decision | Choice | Rationale |
|----------|--------|-----------|
| Tool ID Field | `tool.slug` not `tool.name` | Composio expects action names for execution |
| API Limit | `limit: 100` | Fetch all available tools, not just first 10-20 |
| Error Handling | Silent warnings | Should be more prominent in future |

---

## 4. Technical Deep Dive

### The Tool ID Mismatch

**Composio's `getRawComposioTools()` returns:**
```typescript
{
  slug: "GMAIL_FETCH_EMAILS",      // Action name for execution
  name: "Fetch emails",            // Human-readable display name  
  displayName: "Fetch emails",     // Same as name
  description: "Fetches a list of email messages..."
}
```

**Before (BUGGY):**
```typescript
return (tools || []).map((tool) => ({
  id: tool.name || "",        // ❌ "Fetch emails" - display name!
  name: tool.displayName || tool.name || "",
  description: tool.description || "",
}));
```

**After (FIXED):**
```typescript
return (tools || []).map((tool) => ({
  id: tool.slug || tool.name || "",  // ✅ "GMAIL_FETCH_EMAILS" - action name
  name: tool.displayName || tool.name || "",
  description: tool.description || "",
}));
```

### Execution Flow (Traced)

**Before Fix:**
1. User selects "Fetch emails" → saves `toolId: "Fetch emails"`
2. Chat route calls `getToolAction(userId, "Fetch emails")`
3. Composio SDK: `client.tools.get(userId, { tools: ["Fetch emails"] })`
4. Composio returns NOTHING - "Fetch emails" isn't a valid action name
5. Tool loading fails, skipped
6. Agent has no email tools in toolMap

**After Fix:**
- Step 1 saves: `{ toolId: "GMAIL_FETCH_EMAILS", ... }`
- Step 3 calls: `client.tools.get(userId, { tools: ["GMAIL_FETCH_EMAILS"] })`
- Step 4: Composio returns the tool definition ✓
- Step 6: Agent has email tools ✓

---

## 5. Lessons Learned

- **Field names matter:** Composio tools have multiple identifier fields - always verify which is used for what purpose
- **Silent failures are dangerous:** Tool loading failure was silent - no error thrown, just warning logged
- **Test end-to-end:** We tested displaying and saving tools, but missed actually using them in chat

---

## 6. Next Steps

- [ ] More prominent logging for tool loading failures
- [ ] Tool health check in Capabilities tab
- [ ] Error state in UI when assigned tools can't be loaded

---

## References

- **Related Diary:** `17-ConnectionToolsIntegration.md` - Initial implementation
- **Related Diary:** `17.2-ConnectionToolSchemaFix.md` - Schema fix

---

**Last Updated:** 2025-12-04
