# Task 15.3: Workflow Editor — Implementation Plan

**Status:** Planning  
**Date:** December 2025  
**Goal:** Build a visual workflow editor that generates Mastra-native workflow code from Composio tool compositions.

---

## 1. Executive Summary

The Agipo platform currently has an agent system that can use individual tools. What's missing is the ability to compose multiple tools into reusable workflows that agents can execute.

This implementation adds a new Workflow Editor that allows users to:
1. Visually compose Composio tools into multi-step workflows
2. Define data mappings between steps
3. Test workflows with step-by-step visibility
4. Generate Mastra-compatible TypeScript code
5. Assign workflows to agents
6. Read from and write to Records (structured data tables)

**End state:** Users can create, test, and assign workflows to agents, with the "Daily Job Scraper" (scrape jobs → write to table) as a key use case demonstrating table integration.

---

## 2. Current State Analysis

### 2.1 How It Works Today

**Agents can use individual tools:**

```
User → Agent Chat → Agent calls tool → Tool executes → Result returned
```

**Tools are stored in `_tables/tools/`:**

```
_tables/tools/
├── hohoho/
│   ├── workflow.json    # Editor state (nodes, edges)
│   └── tool.js          # Generated JavaScript
└── wazzup/
    ├── workflow.json
    └── tool.js
```

**No workflow composition exists** - each tool is standalone.

### 2.2 Key Data Structures

**Existing types we'll extend:**

```typescript
// _tables/types.ts
type ConnectionToolBinding = {
  toolId: string;        // "GMAIL_SEND_EMAIL"
  connectionId: string;  // "ca_abc123"
  toolkitSlug: string;   // "gmail"
};

// Existing tool editor state (_tables/tools/hohoho/workflow.json)
interface WorkflowData {
  name: string;
  description: string;
  nodes: Array<{
    id: string;
    type: "code";
    position: { x: number; y: number };
    data: {
      title: string;
      code: string;
      spec: { inputs: [...], process: [...], outputs: [...] };
    };
  }>;
  edges: Array<{ id: string; source: string; target: string }>;
}
```

### 2.3 Relevant Primitives/APIs

From research (see `15.2-workflow-research.md`):

| Primitive | Package | Purpose |
|-----------|---------|---------|
| `createWorkflow()` | `@mastra/core` | Define workflow with input/output schemas |
| `createStep()` | `@mastra/core` | Define individual step with execute function |
| `.then()` | `@mastra/core` | Chain steps sequentially |
| `.map()` | `@mastra/core` | Define data mapping between steps |
| `.parallel()` | `@mastra/core` | Run steps concurrently |
| `.branch()` | `@mastra/core` | Conditional execution |
| `.commit()` | `@mastra/core` | Finalize workflow for execution |
| `createRunAsync()` | `@mastra/core` | Create executable run instance |
| `run.stream()` | `@mastra/core` | Stream execution events |
| `client.tools.retrieve()` | `@composio/client` | Get tool with schemas |
| `client.tools.execute()` | `@composio/client` | Execute tool with arguments |
| `queryTable()` | Records service | Query rows from a table |
| `insertRow()` | Records service | Insert row to a table |
| `getTableSchema()` | Records service | Get table column definitions |

**Key insight from research:** Composio DOES provide `outputParameters` for all tools (verified Dec 6, 2025).

**Records integration:** Existing `app/api/records/services/` provides query, insert, update, delete operations. Tables stored in `_tables/records/[tableId]/`.

---

## 3. Acceptance Criteria

Full acceptance criteria (81 items) are in `15-workflow-editor.md` Section 7. 

### Phase 1 Scope (Foundation + List View)

| # | Criterion | Category | Testable By |
|---|-----------|----------|-------------|
| AC-1.1 | Palette displays Composio tools from connected integrations | Discovery | See tools in palette |
| AC-1.2 | Palette displays NO_AUTH tools | Discovery | browser_tool visible |
| AC-2.1 | Each node displays input schema | IPO | Fields visible on node |
| AC-2.2 | Each node displays output schema | IPO | Fields visible on node |
| AC-12.2 | List view displays workflow as sequential steps | Views | List renders correctly |
| AC-13.1 | Workflow saved to `_tables/workflows/` | Persistence | File created on save |

### Phase 2 Scope (Palette + Canvas View)

| # | Criterion | Category | Testable By |
|---|-----------|----------|-------------|
| AC-1.5 | Tools grouped by toolkit | Discovery | Visual grouping |
| AC-1.6 | Tools searchable by name | Discovery | Filter works |
| AC-1.7 | Drag tool to canvas creates node | Discovery | Drag-drop works |
| AC-12.1 | Canvas view displays workflow as graph | Views | ReactFlow renders |
| AC-12.3 | Both views share same state | Views | Edit in one, see in other |

### Phase 3 Scope (Data Mapping)

| # | Criterion | Category | Testable By |
|---|-----------|----------|-------------|
| AC-7.1 | Data mapping UI shows source fields | Mapping | Click edge → see fields |
| AC-7.2 | Data mapping UI shows target fields | Mapping | Click edge → see fields |
| AC-7.3 | User can map fields | Mapping | Select mapping → saved |
| AC-7.4 | Nested field access works | Mapping | `user.email` → works |
| AC-3.1 | Type validation on edges | Validation | Warning on mismatch |

### Phase 4 Scope (Testing + Code Gen)

| # | Criterion | Category | Testable By |
|---|-----------|----------|-------------|
| AC-8.1 | Test runs workflow with inputs | Testing | Click Test → executes |
| AC-8.4 | Step-by-step progress shown | Testing | See each step status |
| AC-8.5 | Errors shown clearly | Testing | Failed step highlighted |
| AC-13.2 | Generated code saved to workflow.ts | CodeGen | TypeScript file created |

---

## 4. User Flows

Full user flows (15 flows) are in `15-workflow-editor.md` Section 8.

**Critical flows for Phase 1:**
- Flow 1: Create New Workflow
- Flow 2: Add First Node from Palette
- Flow 9: Switch Between Canvas and List Views

**Critical flows for Phase 2:**
- Flow 3: Add Second Node and Connect
- Flow 4: Define Runtime Inputs

**Critical flows for Phase 3:**
- Flow 14: Data Mapping with Nested Fields

**Critical flows for Phase 4:**
- Flow 6: Test Workflow - New Test Case
- Flow 8: Handle Test Failure

---

## 5. File Impact Analysis

### 5.1 New Folders to Create

| Folder | Purpose |
|--------|---------|
| `_tables/workflows/` | Workflow storage (JSON + generated TS) |
| `app/(pages)/workflows/` | Frontend pages |
| `app/api/workflows/` | Backend API routes |

### 5.2 Files to Create

| File | Action | Description |
|------|--------|-------------|
| `_tables/workflows/.gitkeep` | **Create** | Ensure folder exists |
| `app/(pages)/workflows/page.tsx` | **Create** | Workflow list page |
| `app/(pages)/workflows/editor/page.tsx` | **Create** | Main editor page |
| `app/(pages)/workflows/editor/components/Canvas.tsx` | **Create** | ReactFlow canvas view |
| `app/(pages)/workflows/editor/components/ListView.tsx` | **Create** | Sequential list view |
| `app/(pages)/workflows/editor/components/ToolPalette.tsx` | **Create** | Composio tool browser |
| `app/(pages)/workflows/editor/components/NodeInspector.tsx` | **Create** | Selected node details |
| `app/(pages)/workflows/editor/components/DataMappingModal.tsx` | **Create** | Edge mapping UI |
| `app/(pages)/workflows/editor/components/InputsPanel.tsx` | **Create** | Runtime inputs config |
| `app/(pages)/workflows/editor/components/ConfigPanel.tsx` | **Create** | Workflow configs |
| `app/(pages)/workflows/editor/components/ConnectionsPanel.tsx` | **Create** | Required connections |
| `app/(pages)/workflows/editor/components/TestPanel.tsx` | **Create** | Test execution UI |
| `app/(pages)/workflows/editor/store/index.ts` | **Create** | Zustand store |
| `app/(pages)/workflows/editor/hooks/useComposioTools.ts` | **Create** | Fetch available tools |
| `app/(pages)/workflows/editor/hooks/usePersistence.ts` | **Create** | Auto-save logic |
| `app/api/workflows/create/route.ts` | **Create** | POST - create workflow |
| `app/api/workflows/list/route.ts` | **Create** | GET - list workflows |
| `app/api/workflows/[workflowId]/route.ts` | **Create** | GET/PATCH/DELETE |
| `app/api/workflows/[workflowId]/execute/route.ts` | **Create** | POST - run workflow |
| `app/api/workflows/[workflowId]/test/route.ts` | **Create** | POST - test run |
| `app/api/workflows/services/types.ts` | **Create** | TypeScript types |
| `app/api/workflows/services/generator.ts` | **Create** | JSON → TypeScript transpiler |
| `app/api/workflows/services/executor.ts` | **Create** | Workflow execution |
| `app/api/workflows/services/validator.ts` | **Create** | Schema validation |

### 5.3 Files to Modify

| File | Action | Description |
|------|--------|-------------|
| `app/components/header/index.tsx` | Modify | Add "Workflows" nav item |
| `_tables/types.ts` | Modify | Add WorkflowDefinition type |

### 5.4 UX Mockups

| Mockup | Location | Starting Point? |
|--------|----------|-----------------|
| List view emphasis | `_docs/UXD/Pages/workflow/Flight A/variation-3/` | **✅ YES** |
| Canvas-first | `_docs/UXD/Pages/workflow/Flight A/variation-1/` | No |
| Timeline approach | `_docs/UXD/Pages/workflow/Flight B/variation-1/` | No |

---

## 6. Implementation Phases

### Phase 1: Foundation + List View

**Goal:** Establish file structure, types, and basic list view for sequential workflows.

**Changes:**
1. Create `_tables/workflows/` folder structure
2. Create `app/api/workflows/` with CRUD endpoints
3. Create `app/(pages)/workflows/` with list page and editor shell
4. Implement `WorkflowDefinition` and `WorkflowStep` types (see 15.3a)
5. Implement list view component (no canvas yet)
6. Implement basic tool palette (flat list)
7. Add "Workflows" link to header navigation

**File Impact:**

| File | Action |
|------|--------|
| `_tables/workflows/.gitkeep` | Create |
| `_tables/types.ts` | Modify - add workflow types |
| `app/api/workflows/create/route.ts` | Create |
| `app/api/workflows/list/route.ts` | Create |
| `app/api/workflows/[workflowId]/route.ts` | Create |
| `app/api/workflows/services/types.ts` | Create |
| `app/(pages)/workflows/page.tsx` | Create |
| `app/(pages)/workflows/editor/page.tsx` | Create |
| `app/(pages)/workflows/editor/components/ListView.tsx` | Create |
| `app/(pages)/workflows/editor/components/ToolPalette.tsx` | Create (basic) |
| `app/(pages)/workflows/editor/store/index.ts` | Create |
| `app/components/header/index.tsx` | Modify |

**Phase 1 Acceptance Criteria:**

| # | Criterion | Test Method |
|---|-----------|-------------|
| P1.1 | Workflows link visible in header | Visual check |
| P1.2 | Workflows list page loads | Navigate to /workflows |
| P1.3 | "New Workflow" creates empty workflow | Click button → workflow created |
| P1.4 | Editor loads with list view | Navigate to /workflows/editor |
| P1.5 | Tool palette shows available tools | Tools visible in panel |
| P1.6 | Can add step to list | Click tool → step appears |
| P1.7 | Can reorder steps in list | Drag-drop reorder |
| P1.8 | Workflow saves to `_tables/workflows/` | Save → file exists |

**Phase 1 Test Flow:**
```
1. Start dev server
2. Navigate to /workflows
3. Click "New Workflow"
4. Name workflow "Test Workflow"
5. Add FIRECRAWL_SCRAPE from palette
6. Add custom code step
7. Reorder steps
8. Save workflow
9. Check _tables/workflows/[id]/workflow.json exists
```

---

### Phase 2: Canvas View + Tool Grouping

**Goal:** Add ReactFlow canvas view and improve tool palette organization.

**Changes:**
1. Implement ReactFlow canvas with custom nodes
2. Implement ToolNode component (displays I/O)
3. Implement view toggle (list ↔ canvas)
4. Group tools by toolkit in palette
5. Add search/filter to palette
6. Ensure both views read/write same state

**File Impact:**

| File | Action |
|------|--------|
| `app/(pages)/workflows/editor/components/Canvas.tsx` | Create |
| `app/(pages)/workflows/editor/components/nodes/ToolNode.tsx` | Create |
| `app/(pages)/workflows/editor/components/nodes/CustomCodeNode.tsx` | Create |
| `app/(pages)/workflows/editor/components/ToolPalette.tsx` | Modify - add grouping |
| `app/(pages)/workflows/editor/store/index.ts` | Modify - add view state |

**Phase 2 Acceptance Criteria:**

| # | Criterion | Test Method |
|---|-----------|-------------|
| P2.1 | Canvas view renders with ReactFlow | Toggle to canvas |
| P2.2 | Nodes display I/O schemas | Visual check |
| P2.3 | Drag from palette to canvas works | Drag-drop interaction |
| P2.4 | Tools grouped by toolkit | Visual grouping |
| P2.5 | Tool search works | Type → filter results |
| P2.6 | Edit in list → canvas updates | Cross-view sync |
| P2.7 | Edit in canvas → list updates | Cross-view sync |

**Phase 2 Test Flow:**
```
1. Open existing workflow
2. Toggle to canvas view
3. Verify nodes match list view
4. Drag new tool from palette to canvas
5. Toggle to list view → new step appears
6. Search for "gmail" → only Gmail tools shown
```

---

### Phase 3: Data Mapping + Connections

**Goal:** Enable data flow between steps and connection requirement detection.

**Changes:**
1. Implement edge creation (canvas: draw line; list: dropdown)
2. Implement DataMappingModal component
3. Implement type validation on edges
4. Auto-detect required connections from tool nodes
5. Implement ConnectionsPanel
6. Implement InputsPanel (runtime inputs)
7. Implement ConfigPanel (workflow configs)

**File Impact:**

| File | Action |
|------|--------|
| `app/(pages)/workflows/editor/components/DataMappingModal.tsx` | Create |
| `app/(pages)/workflows/editor/components/ConnectionsPanel.tsx` | Create |
| `app/(pages)/workflows/editor/components/InputsPanel.tsx` | Create |
| `app/(pages)/workflows/editor/components/ConfigPanel.tsx` | Create |
| `app/api/workflows/services/validator.ts` | Create |

**Phase 3 Acceptance Criteria:**

| # | Criterion | Test Method |
|---|-----------|-------------|
| P3.1 | Can create edge between nodes | Draw line / select source |
| P3.2 | Data mapping modal opens on edge click | Click edge → modal |
| P3.3 | Can map output field → input field | Select mapping |
| P3.4 | Nested paths work (user.email) | Type path → validates |
| P3.5 | Type mismatches show warning | Connect number→string |
| P3.6 | Required connections auto-detected | Add Gmail tool → shown |
| P3.7 | Runtime inputs definable | Add input in panel |
| P3.8 | Configs definable | Add config in panel |

**Phase 3 Test Flow:**
```
1. Add FIRECRAWL_SCRAPE step
2. Add custom code step
3. Connect them (canvas: draw edge; list: select source)
4. Open data mapping modal
5. Map data.title → jobTitle
6. Define runtime input: jobUrl (string, required)
7. Reference {{inputs.jobUrl}} in first step
8. Check ConnectionsPanel shows "Requires: Firecrawl"
```

---

### Phase 4: Testing Suite + Code Generation

**Goal:** Enable workflow testing and generate Mastra TypeScript code.

**Changes:**
1. Implement TestPanel with execution UI
2. Implement test execution with step-by-step streaming
3. Implement error display (failed node highlighting)
4. Implement code generator (workflow.json → workflow.ts)
5. Generate workflow.ts on save

**File Impact:**

| File | Action |
|------|--------|
| `app/(pages)/workflows/editor/components/TestPanel.tsx` | Create |
| `app/(pages)/workflows/editor/components/ExecutionResults.tsx` | Create |
| `app/api/workflows/[workflowId]/test/route.ts` | Create |
| `app/api/workflows/services/generator.ts` | Create |
| `app/api/workflows/services/executor.ts` | Create |

**Phase 4 Acceptance Criteria:**

| # | Criterion | Test Method |
|---|-----------|-------------|
| P4.1 | Test button visible | Click Test tab |
| P4.2 | Test form accepts runtime inputs | Fill inputs |
| P4.3 | Test execution shows step progress | Run → see steps |
| P4.4 | Successful steps show ✓ | Visual check |
| P4.5 | Failed steps show ✗ + error | Cause failure → see error |
| P4.6 | workflow.ts generated on save | Check file exists |
| P4.7 | Generated code is valid TypeScript | No syntax errors |

**Phase 4 Test Flow:**
```
1. Create workflow with 2 steps
2. Click Test tab
3. Fill runtime inputs
4. Click "Run Test"
5. Watch step-by-step execution
6. Verify all steps pass
7. Save workflow
8. Check _tables/workflows/[id]/workflow.ts exists
9. Verify TypeScript compiles
```

---

### Phase 5: Agent Integration

**Goal:** Allow agents to execute workflows.

**Changes:**
1. Add workflow assignment UI to agent modal
2. Implement config value collection on assignment
3. Update agent chat to recognize workflow calls
4. Implement workflow execution from agent context
5. Return workflow results to agent

**File Impact:**

| File | Action |
|------|--------|
| `app/(pages)/workforce/[agentId]/components/WorkflowAssignment.tsx` | Create |
| `app/api/workforce/[agentId]/workflows/route.ts` | Create |
| `app/api/workforce/[agentId]/chat/services/workflow-executor.ts` | Create |
| `app/api/workforce/[agentId]/chat/route.ts` | Modify |

**Phase 5 Acceptance Criteria:**

| # | Criterion | Test Method |
|---|-----------|-------------|
| P5.1 | Can assign workflow to agent | UI works |
| P5.2 | Config values collected on assignment | Form shown |
| P5.3 | Agent can call workflow | Chat → workflow runs |
| P5.4 | Workflow results returned | Agent receives output |
| P5.5 | Missing connections blocked | Error if required connection missing |

---

### Phase 6: Table Integration

**Goal:** Enable workflows to read from and write to Records (tables).

**Changes:**
1. Add TableRequirements to workflow schema
2. Implement Tables panel in editor for defining table requirements
3. Implement Query Table node type
4. Implement Write to Table node type
5. Update assignment UI to show table requirements
6. Implement table selection/creation during assignment
7. Implement column mapping UI

**File Impact:**

| File | Action |
|------|--------|
| `app/(pages)/workflows/editor/components/TablesPanel.tsx` | Create |
| `app/(pages)/workflows/editor/components/nodes/QueryTableNode.tsx` | Create |
| `app/(pages)/workflows/editor/components/nodes/WriteTableNode.tsx` | Create |
| `app/(pages)/workflows/editor/components/TableRequirementForm.tsx` | Create |
| `app/(pages)/workflows/editor/components/TableColumnMapping.tsx` | Create |
| `app/(pages)/workforce/[agentId]/components/TableAssignment.tsx` | Create |
| `app/api/workflows/services/table-executor.ts` | Create |
| `app/api/workflows/services/types.ts` | Modify - add TableRequirement type |

**Phase 6 Acceptance Criteria:**

| # | Criterion | Test Method |
|---|-----------|-------------|
| P6.1 | Can add table requirement in editor | Tables panel → add requirement |
| P6.2 | Table requirement specifies columns | Column list shows |
| P6.3 | Assignment shows table requirements | Modal shows Tables section |
| P6.4 | Can select existing compatible table | Dropdown works |
| P6.5 | Can create new table with schema | Create button → table created |
| P6.6 | Column mapping works | Map different column names |
| P6.7 | Query Table node returns rows | Configure query → results |
| P6.8 | Write to Table node inserts row | Run workflow → row in table |

**Phase 6 Test Flow:**
```
1. Create workflow with "Write to Table" node
2. Add table requirement: output_table (write)
   - Columns: job_title (text), company (text), url (text)
3. Save workflow
4. Assign to agent
5. Select "Create new table" → "Job Listings"
6. Run test with sample data
7. Check _tables/records/job-listings/records.json has new row
```
| P5.3 | Agent can call workflow | Chat → workflow runs |
| P5.4 | Workflow results returned | Agent receives output |
| P5.5 | Missing connections blocked | Error if Gmail not connected |

---

## 7. Design Decisions

| Decision | Choice | Rationale |
|----------|--------|-----------|
| Start with list view | Flight A V3 | More approachable for users |
| Hybrid code gen | Runtime test, codegen prod | Fast iteration + reliable production |
| workflow.json for state | JSON not SQLite | Consistent with existing patterns |
| Both views from start | List + Canvas | Core requirement from product owner |
| Direct mapping MVP | No transforms v1 | Simplicity; Code nodes handle transforms |
| Tables as configs | Set at assignment time | Like connections, tables bound when workflow assigned |
| Dedicated table nodes | Query Table, Write to Table | Explicit operations are clearer for MVP |
| Column mapping at assignment | Map workflow→table columns | Handles name differences gracefully |
| Superset tables OK | Extra columns ignored | Flexibility for users with existing tables |
| Auto-create tables | Yes, with suggested schema | Reduces friction for new workflows |

---

## 8. Out of Scope

- Workflow marketplace (P2)
- Workflows calling other workflows (P2)
- Loop control flow nodes (P2)
- Wait/human-in-loop nodes (P2)
- Test case sharing between workflows
- Workflow forking/copying
- WebContainer execution (explicitly avoided)
- Table RAG integration (P2) - tables as AI memory/context
- Table triggers (P2) - "run workflow when table changes"
- Cross-table joins (P2) - querying multiple tables together
- Table as runtime input (future) - currently tables are configs only

---

## 9. References

- **Product Spec:** `15-workflow-editor.md`
- **Research (Parallel 1):** `15.1-workflow-research.md`
- **Research (Parallel 2):** `15.2-workflow-research.md`
- **Schema Design:** `15.3a-workflow-json-schema.md`
- **Mastra Primitives:** `_docs/Engineering/Integrations/API Docs/Mastra/Workflow-Primitives.md`
- **UXD Mockups:** `_docs/UXD/Pages/workflow/`
- **Existing Tool Pattern:** `_tables/tools/hohoho/`

---

## 10. Completed Work

*Track progress as implementation proceeds.*

### Phase 0: Research ✅

**Issue:** Needed to understand Mastra workflow primitives and Composio schema availability.

**Fix:** Completed comprehensive research in 15.1 and 15.2, verified all APIs via source code inspection and live queries.

**Status:** Complete (Dec 6, 2025)

### Phase 1: UXD Mockups ✅

**Issue:** Needed visual designs before implementation.

**Fix:** Created Flight A and Flight B mockups with 3 variations each.

**Status:** Complete (Dec 6, 2025)

---

## Notes

- The `@composio/mastra` package is incompatible with current `@mastra/core@0.24.6`. Use manual tool wrapping as documented in existing `composio-tools.ts`.
- Composio's `outputParameters` field uses camelCase when accessed via `getRawComposioTools()`.
- Terminal nodes (e.g., Send Email) don't need output schema validation.

