# Task 15.5: Workflows C Implementation Plan

**Status:** In Progress  
**Date:** December 6, 2025  
**Developer:** Workflows C Implementation  
**Parallel To:** Workflows (original), Workflows B

---

## 0. Grounding: What This Implementation Must Respect

### 0.1 Mastra Primitive Mapping

Every visual element in this editor translates to Mastra code. This mapping is **not negotiable**:

| Visual Editor Concept | Mastra Primitive | Generated Code |
|----------------------|------------------|----------------|
| A node on the canvas/list | `Step` | `createStep({ id, inputSchema, outputSchema, execute })` |
| **A line between nodes** | **`.map()`** | `{ field: { step: sourceStep, path: "sourcePath" } }` |
| The workflow itself | `Workflow` | `createWorkflow({ id, inputSchema, outputSchema })` |
| Sequential connection | `.then()` | `.then(stepA).then(stepB)` |
| Fork into parallel | `.parallel()` | `.parallel([stepA, stepB])` |
| If/else branch | `.branch()` | `.branch([[condition, step], ...])` |
| Finalize | `.commit()` | Always required at end |

### 0.2 Data Model (From types.ts)

I'm using the **existing** `WorkflowDefinition` from `app/api/workflows/services/types.ts`:
- `WorkflowStep` with `position` (canvas) + `listIndex` (list view)
- `DataMapping` with `fieldMappings[]` representing the "lines"
- `ControlFlowConfig` for sequential/parallel/branched execution
- `RuntimeInputConfig` for agent-provided values
- `WorkflowConfig` for assignment-time configuration

### 0.3 UX Pattern (From Flight A Mockups)

**Layout follows Flight A patterns:**
- **Sidebars** from `Flight A/variation-1/` (Chat left, Tabbed panels right)
- **Center list view** from `Flight A/variation-3/` (Timeline with progressive disclosure)

### 0.4 Key Research Findings Applied

| Finding | Source | How I'm Using It |
|---------|--------|------------------|
| Composio has `outputParameters` | RQ-10 | Full bidirectional type validation |
| `.map()` is the "line" | 15.2 Part 5 | Data mapping UI generates `.map()` config |
| Hybrid code-gen | OQ-1 | Runtime for testing, .ts for production |
| `@composio/mastra` incompatible | RQ-12 | Manual wrapping via existing patterns |

---

## 1. Design Philosophy: "Blueprint"

### 1.1 Core Concept

> **Workflows as Blueprints** â€” A technical, precise, keyboard-driven interface that treats workflow creation like drafting an architectural schematic.

Where other implementations focus on drag-drop simplicity, Workflows C embraces a **power-user aesthetic**:
- Dark theme with high contrast
- Command palette (Cmd+K) as primary interaction
- Dense, information-rich displays
- Always-visible data flow inspection
- Real-time code generation preview

### 1.2 Target User

The developer or technical power user who:
- Prefers keyboard over mouse
- Wants to see generated code
- Values information density over whitespace
- Thinks in terms of data transformations (understands `.map()` concept)

### 1.3 Visual Identity

| Element | Choice | Rationale |
|---------|--------|-----------|
| **Background** | Dark slate (#0F172A) | Professional, reduces eye strain |
| **Accent** | Cyan (#06B6D4) | Technical, stands out on dark |
| **Grid** | Dot pattern | Blueprint aesthetic |
| **Font** | JetBrains Mono | Code-first identity |
| **Cards** | Glassmorphism | Modern, layered depth |

---

## 2. Differentiating Features

### 2.1 Command Palette (Cmd+K)

All actions accessible via command palette:

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ > _                                                         â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Recent Actions                                              â”‚
â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                                               â”‚
â”‚ ğŸ”§ Add Composio Tool...                                     â”‚
â”‚ ğŸ’» Add Custom Code Step                                     â”‚
â”‚ ğŸ”€ Add Branch Condition                                     â”‚
â”‚ âš¡ Add Parallel Block                                       â”‚
â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                                               â”‚
â”‚ ğŸ“¥ Define Runtime Input                                     â”‚
â”‚ âš™ï¸  Define Config                                           â”‚
â”‚ ğŸ§ª Run Test                                                 â”‚
â”‚ ğŸ’¾ Save Workflow                                            â”‚
â”‚ ğŸ“œ View Generated Code                                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 2.2 Blueprint View

Instead of timeline or canvas, a **block-based schematic**:

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”“  â”‚
â”‚  â”ƒ  INPUT                                                â”ƒ  â”‚
â”‚  â”ƒ  â”€â”€â”€â”€â”€â”€                                               â”ƒ  â”‚
â”‚  â”ƒ  jobUrl: string                                       â”ƒ  â”‚
â”‚  â”—â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”›  â”‚
â”‚                           â”‚                                  â”‚
â”‚                           â–¼                                  â”‚
â”‚  â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”“  â”‚
â”‚  â”ƒ 1. FIRECRAWL_SCRAPE                    ğŸ”§ Firecrawl  â”ƒ  â”‚
â”‚  â”ƒ    url â† $input.jobUrl                               â”ƒ  â”‚
â”‚  â”ƒ    â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                              â”ƒ  â”‚
â”‚  â”ƒ    â†’ data.title, data.company, data.requirements     â”ƒ  â”‚
â”‚  â”—â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”›  â”‚
â”‚                           â”‚                                  â”‚
â”‚          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                â”‚
â”‚          â–¼                                 â–¼                â”‚
â”‚  â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”“          â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”“        â”‚
â”‚  â”ƒ 2a. Analyze      â”ƒ          â”ƒ 2b. Get Company  â”ƒ        â”‚
â”‚  â”ƒ     Requirements â”ƒ          â”ƒ     Info         â”ƒ        â”‚
â”‚  â”—â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”›          â”—â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”›        â”‚
â”‚          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                â”‚
â”‚                           â–¼                                  â”‚
â”‚  â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”“  â”‚
â”‚  â”ƒ 3. Generate Resume                      ğŸ’» Custom    â”ƒ  â”‚
â”‚  â”—â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”›  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 2.3 Split Data Inspector

Always visible panel showing data shape at selected step:

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  DATA AT STEP 1                                             â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  {                                                          â”‚
â”‚    "data": {                                                â”‚
â”‚      "title": "Senior Engineer",        // string           â”‚
â”‚      "company": "Acme Inc",             // string           â”‚
â”‚      "requirements": [                  // string[]         â”‚
â”‚        "TypeScript",                                        â”‚
â”‚        "React"                                              â”‚
â”‚      ]                                                      â”‚
â”‚    },                                                       â”‚
â”‚    "successful": true,                  // boolean          â”‚
â”‚    "error": null                        // string | null    â”‚
â”‚  }                                                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 2.4 Inline Code Preview

Generated TypeScript visible without leaving editor:

```typescript
// Auto-generated preview
const workflow = createWorkflow({
  id: "job-scraper",
  inputSchema: z.object({ jobUrl: z.string().url() }),
  outputSchema: z.object({ resume: z.string() }),
})
.then(scrapeStep)
.map({ ... })
.then(generateStep)
.commit();
```

---

## 3. Architecture

### 3.1 Folder Structure

```
_tables/workflows-c/
  [workflowId]/
    workflow.json        # Editor state
    workflow.ts          # Generated Mastra code

app/(pages)/workflows-c/
  page.tsx               # List page (dark theme)
  editor/
    page.tsx             # Blueprint editor
    components/
      BlueprintCanvas.tsx
      CommandPalette.tsx
      DataInspector.tsx
      StepBlock.tsx
      FlowConnector.tsx
      CodePreview.tsx
      ToolSearch.tsx
    hooks/
      useCommandPalette.ts
      useKeyboardNav.ts
      useBlueprintState.ts
    store/
      index.ts
      slices/
        stepsSlice.ts
        mappingsSlice.ts
        inputsSlice.ts
        configsSlice.ts
        uiSlice.ts

app/api/workflows-c/
  create/route.ts
  list/route.ts
  [workflowId]/route.ts
```

### 3.2 Store Architecture

```typescript
interface WorkflowsCStore {
  // Workflow Identity
  workflow: WorkflowDefinition | null;
  
  // Steps
  steps: WorkflowStep[];
  selectedStepId: string | null;
  
  // Data Flow
  mappings: DataMapping[];
  
  // Configuration
  runtimeInputs: RuntimeInputConfig[];
  configs: WorkflowConfig[];
  
  // UI State
  commandPaletteOpen: boolean;
  codePreviewOpen: boolean;
  zoomLevel: number;
  
  // Actions
  addStep: (step: Partial<WorkflowStep>) => void;
  removeStep: (id: string) => void;
  updateStep: (id: string, updates: Partial<WorkflowStep>) => void;
  selectStep: (id: string | null) => void;
  addMapping: (mapping: DataMapping) => void;
  toggleCommandPalette: () => void;
}
```

---

## 4. Implementation Phases

### Phase 1: Foundation (Current)
- [x] Create implementation plan
- [ ] Create folder structure
- [ ] Add nav entry
- [ ] Create basic API routes
- [ ] Create list page with dark theme

### Phase 2: Editor Shell
- [ ] Create editor layout with 3 panels
- [ ] Implement command palette (Cmd+K)
- [ ] Create basic step blocks
- [ ] Add keyboard navigation

### Phase 3: Blueprint View
- [ ] Build step block components
- [ ] Add flow connectors (vertical lines)
- [ ] Implement parallel/branch visual blocks
- [ ] Add dot-grid background

### Phase 4: Tool Integration
- [ ] Integrate Composio tool fetching
- [ ] Tool search in command palette
- [ ] Auto-populate input/output schemas

### Phase 5: Data Mapping
- [ ] Split data inspector panel
- [ ] Inline mapping in step blocks
- [ ] Type validation indicators
- [ ] Auto-map feature

### Phase 6: Testing & Code Gen
- [ ] Test execution panel
- [ ] Code preview panel
- [ ] Save workflow â†’ generate .ts

---

## 5. Keyboard Shortcuts

| Shortcut | Action |
|----------|--------|
| `Cmd+K` | Open command palette |
| `Cmd+S` | Save workflow |
| `Cmd+Enter` | Run test |
| `â†‘/â†“` | Navigate steps |
| `Enter` | Select/Edit step |
| `Escape` | Deselect / Close palette |
| `Cmd+/` | Toggle code preview |
| `Cmd+Shift+D` | Toggle data inspector |
| `Tab` | Next field in mapping |
| `Delete` | Remove selected step |

---

## 6. Visual Design Tokens

```css
:root {
  /* Background */
  --bg-primary: #0F172A;      /* slate-900 */
  --bg-secondary: #1E293B;    /* slate-800 */
  --bg-elevated: #334155;     /* slate-700 */
  
  /* Accent */
  --accent-primary: #06B6D4;  /* cyan-500 */
  --accent-secondary: #0EA5E9;/* sky-500 */
  
  /* Text */
  --text-primary: #F8FAFC;    /* slate-50 */
  --text-secondary: #94A3B8;  /* slate-400 */
  --text-muted: #64748B;      /* slate-500 */
  
  /* Status */
  --success: #10B981;         /* emerald-500 */
  --warning: #F59E0B;         /* amber-500 */
  --error: #EF4444;           /* red-500 */
  
  /* Borders */
  --border-subtle: #334155;   /* slate-700 */
  --border-accent: #06B6D4;   /* cyan-500 */
  
  /* Grid */
  --grid-dot: #334155;        /* slate-700 */
}
```

---

## 7. Acceptance Criteria

| # | Criterion | Phase |
|---|-----------|-------|
| AC-C1 | Dark theme throughout editor | 1 |
| AC-C2 | Command palette opens with Cmd+K | 2 |
| AC-C3 | Steps display as blueprint blocks | 3 |
| AC-C4 | Parallel steps show side-by-side | 3 |
| AC-C5 | Data inspector shows schema at selected step | 5 |
| AC-C6 | Code preview shows generated TypeScript | 6 |
| AC-C7 | Keyboard navigation works for all actions | 2 |
| AC-C8 | Tool search filters Composio tools | 4 |
| AC-C9 | Test execution shows step progress | 6 |
| AC-C10 | Workflow saves to _tables/workflows-c/ | 6 |

---

## 8. References

- Product Spec: `15-workflow-editor.md`
- Research: `15.2-workflow-research.md`
- Mastra Primitives: `Workflow-Primitives.md`
- Flight C UXD: `_docs/UXD/Pages/workflow/Flight C/`
- Existing Workflows: `app/(pages)/workflows/`

