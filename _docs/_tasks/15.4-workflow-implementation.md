# Task 15.4: Workflow Editor — Implementation Plan

**Status:** Planning  
**Date:** December 2025  
**Goal:** Build a visual workflow editor that generates Mastra-native workflow code from Composio tool compositions.

---

## 1. Executive Summary

The Agipo platform currently allows agents to use individual tools (both custom code and Composio integrations). What's missing is the ability to compose multiple tools into reusable, multi-step workflows.

This implementation adds a new **Workflow Editor** that enables users to:
1. Visually compose Composio tools and custom code into multi-step workflows
2. Define data mappings between steps (how outputs flow to inputs)
3. Test workflows with step-by-step execution visibility
4. Generate Mastra-compatible TypeScript code for production execution
5. Assign workflows as agent capabilities

**End state:** Users can create, test, and publish workflows via a visual editor. The "Job Application Helper" (scrape job → tailor resume) serves as our north star use case.

---

## 2. Current State Analysis

### 2.1 How It Works Today

**Agents use individual tools:**

```
User → Agent Chat → Agent calls tool → Tool executes → Result returned
```

**Tools are stored in `_tables/tools/`:**

```
_tables/tools/
├── hohoho/
│   ├── workflow.json    # Editor state (nodes, edges)
│   └── tool.js          # Generated JavaScript
└── wazzup/
    ├── workflow.json
    └── tool.js
```

The existing "tool editor" creates simple two-node workflows (input → output), but **multi-step composition does not exist**.

### 2.2 Key Data Structures

**Existing types (reference):**

```typescript
// _tables/types.ts
type ConnectionToolBinding = {
  toolId: string;        // "GMAIL_SEND_EMAIL"
  connectionId: string;  // "ca_abc123"
  toolkitSlug: string;   // "gmail"
};
```

**Existing tool editor state pattern:**

```typescript
// _tables/tools/hohoho/workflow.json
interface ToolEditorState {
  name: string;
  description: string;
  nodes: Array<{ id, type, position, data }>;
  edges: Array<{ id, source, target }>;
}
```

### 2.3 Relevant Primitives/APIs

From research (see `15.2-workflow-research.md`):

| Primitive | Package | Purpose |
|-----------|---------|---------|
| `createWorkflow()` | `@mastra/core` | Define workflow with input/output schemas |
| `createStep()` | `@mastra/core` | Define individual step with execute function |
| `.then()` | `@mastra/core` | Chain steps sequentially |
| `.map()` | `@mastra/core` | Define data mapping between steps |
| `.commit()` | `@mastra/core` | Finalize workflow for execution |
| `client.tools.retrieve()` | `@composio/client` | Get tool with schemas |
| `client.tools.execute()` | `@composio/client` | Execute tool with arguments |

**Critical insight:** Composio provides `outputParameters` for all tools, enabling full bidirectional type validation.

---

## 3. Acceptance Criteria

### Discovery & Tool Palette (6 criteria)

| # | Criterion | Testable By |
|---|-----------|-------------|
| AC-1.1 | Palette displays Composio tools from connected integrations | See tools in palette |
| AC-1.2 | Palette displays NO_AUTH tools (browser, firecrawl) | Tools visible without connection |
| AC-1.3 | Custom code option available | "Custom Code" item in palette |
| AC-1.4 | Tools grouped by toolkit | Visual grouping (Gmail, GitHub, etc.) |
| AC-1.5 | Tools searchable by name | Filter works |
| AC-1.6 | Click/drag tool adds step to workflow | Step appears in list |

### Step Management (5 criteria)

| # | Criterion | Testable By |
|---|-----------|-------------|
| AC-2.1 | Each step displays input schema | Fields visible on step card |
| AC-2.2 | Each step displays output schema | Fields visible on step card |
| AC-2.3 | Steps can be reordered | Drag-drop reorder in list |
| AC-2.4 | Steps can be deleted | Delete button removes step |
| AC-2.5 | Step inspector shows full details | Click step → inspector panel |

### Data Mapping (5 criteria)

| # | Criterion | Testable By |
|---|-----------|-------------|
| AC-3.1 | Can map output field → input field | Select mapping in UI |
| AC-3.2 | Can reference runtime inputs | `$url` available as source |
| AC-3.3 | Nested field access works | `data.user.email` → works |
| AC-3.4 | Type validation shows warnings | Mismatch → yellow indicator |
| AC-3.5 | Missing mappings highlighted | Unmapped required fields → red |

### Runtime Inputs & Config (4 criteria)

| # | Criterion | Testable By |
|---|-----------|-------------|
| AC-4.1 | Can define runtime inputs | Add input in panel |
| AC-4.2 | Can define workflow configs | Add config in panel |
| AC-4.3 | Inputs referenceable in mappings | `$inputName` available |
| AC-4.4 | Configs have default values | Default value field |

### Connections (3 criteria)

| # | Criterion | Testable By |
|---|-----------|-------------|
| AC-5.1 | Required connections auto-detected | Add Gmail tool → shown in panel |
| AC-5.2 | Connected status shown | Green indicator for connected |
| AC-5.3 | Missing connections block test | Error if Gmail not connected |

### Testing (6 criteria)

| # | Criterion | Testable By |
|---|-----------|-------------|
| AC-6.1 | Test form accepts runtime inputs | Fill inputs → run |
| AC-6.2 | Test execution shows step progress | Real-time step status |
| AC-6.3 | Successful steps show ✓ | Green check icon |
| AC-6.4 | Failed steps show ✗ + error | Red X with error message |
| AC-6.5 | Can view step output | Click "View output" |
| AC-6.6 | Can stop running test | Stop button works |

### Code Generation (3 criteria)

| # | Criterion | Testable By |
|---|-----------|-------------|
| AC-7.1 | `workflow.ts` generated on save | File exists after save |
| AC-7.2 | Generated code is valid TypeScript | No syntax errors |
| AC-7.3 | Generated code uses Mastra primitives | Contains `createWorkflow`, etc. |

### Persistence (4 criteria)

| # | Criterion | Testable By |
|---|-----------|-------------|
| AC-8.1 | Workflow saved to `_tables/workflows/` | Folder created |
| AC-8.2 | `editor.json` contains editor state | JSON file with nodes, edges, mappings |
| AC-8.3 | Workflow loads from saved state | Reopen → same state |
| AC-8.4 | Auto-save on changes | Modified indicator |

### Views (3 criteria)

| # | Criterion | Testable By |
|---|-----------|-------------|
| AC-9.1 | List view displays workflow as timeline | Steps in vertical list |
| AC-9.2 | Canvas view displays workflow as graph | ReactFlow canvas |
| AC-9.3 | Both views share same state | Edit in one, see in other |

---

## 4. User Flows

### Flow 1: Create New Workflow

```
1. User clicks "Workflows" in top nav
2. User lands on /workflows list page
3. User clicks "New Workflow" button
4. System creates empty workflow with generated ID
5. User is redirected to /workflows/editor?id=[newId]
6. Editor loads with empty state
```

### Flow 2: Add First Step

```
1. User sees "Add a Step" prompt in empty editor
2. User browses tool palette (grouped by toolkit)
3. User clicks on "Firecrawl" group
4. User clicks "Scrape Page" tool
5. System adds step to workflow
6. Step card appears in list view
7. Inspector panel shows step details
```

### Flow 3: Add Second Step and Connect

```
1. User clicks "Add Step" button below Step 1
2. User selects "OpenAI" > "Chat Completion"
3. Step 2 appears below Step 1
4. Data flow indicator shows between steps
5. User clicks on Step 2
6. Inspector shows input mapping section
7. User maps Step 1 outputs → Step 2 inputs
```

### Flow 4: Define Runtime Input

```
1. User clicks "Inputs" quick action
2. Inputs panel opens
3. User clicks "Add Runtime Input"
4. User names input "url" with type "string"
5. Input appears with $ prefix indicator
6. User can now reference $url in step mappings
```

### Flow 5: Test Workflow

```
1. User clicks "Test" button in header
2. Test panel opens (or test tab activates)
3. User fills runtime inputs (url, baseResume)
4. User clicks "Run Test"
5. Progress shows Step 1 running...
6. Step 1 completes → green check
7. Progress shows Step 2 running...
8. Step 2 completes → green check
9. "Passed" banner with total time
```

### Flow 6: Test Failure

```
1. User runs test
2. Step 1 completes successfully
3. Step 2 fails with API error
4. Error banner appears at top
5. Step 2 shows red X with error details
6. User can click "Retry" or "View Details"
```

### Flow 7: Save and Publish

```
1. User clicks "Save" button
2. System saves editor.json to _tables/workflows/[id]/
3. System generates workflow.ts from editor state
4. "Saved" toast confirmation
5. User clicks "Publish"
6. Workflow status changes from "Draft" to "Published"
```

### Flow 8: Switch Views

```
1. User is in List View (default)
2. User clicks Canvas toggle button
3. View transitions to ReactFlow canvas
4. Same steps visible as connected nodes
5. User drags nodes to reposition
6. User switches back to List View
7. Order matches canvas left-to-right/top-to-bottom
```

---

## 5. File Impact Analysis

### 5.1 New Folders to Create

| Folder | Purpose |
|--------|---------|
| `_tables/workflows/` | Workflow storage (editor.json + workflow.ts per workflow) |
| `app/(pages)/workflows/` | Frontend pages |
| `app/api/workflows/` | Backend API routes |

### 5.2 Files to Create

| File | Action | Description |
|------|--------|-------------|
| **Storage** |
| `_tables/workflows/.gitkeep` | **Create** | Ensure folder exists |
| **Types** |
| `app/api/workflows/services/types.ts` | **Create** | WorkflowDefinition, WorkflowStep types |
| **API Routes** |
| `app/api/workflows/create/route.ts` | **Create** | POST - create new workflow |
| `app/api/workflows/list/route.ts` | **Create** | GET - list all workflows |
| `app/api/workflows/[workflowId]/route.ts` | **Create** | GET/PATCH/DELETE single workflow |
| `app/api/workflows/[workflowId]/execute/route.ts` | **Create** | POST - execute workflow |
| **Services** |
| `app/api/workflows/services/storage.ts` | **Create** | Read/write workflow files |
| `app/api/workflows/services/generator.ts` | **Create** | editor.json → workflow.ts transpiler |
| `app/api/workflows/services/executor.ts` | **Create** | Runtime workflow execution |
| **Frontend Pages** |
| `app/(pages)/workflows/page.tsx` | **Create** | Workflow list page |
| `app/(pages)/workflows/editor/page.tsx` | **Create** | Main editor page |
| `app/(pages)/workflows/editor/layout.tsx` | **Create** | Editor layout (3-panel structure) |
| **Store** |
| `app/(pages)/workflows/editor/store/index.ts` | **Create** | Zustand store composition |
| `app/(pages)/workflows/editor/store/types.ts` | **Create** | Store state types |
| `app/(pages)/workflows/editor/store/slices/stepsSlice.ts` | **Create** | Steps state management |
| `app/(pages)/workflows/editor/store/slices/mappingsSlice.ts` | **Create** | Data mappings state |
| `app/(pages)/workflows/editor/store/slices/inputsSlice.ts` | **Create** | Runtime inputs state |
| `app/(pages)/workflows/editor/store/slices/testingSlice.ts` | **Create** | Test execution state |
| `app/(pages)/workflows/editor/store/slices/persistenceSlice.ts` | **Create** | Save/load state |
| **Components - Layout** |
| `app/(pages)/workflows/editor/components/EditorHeader.tsx` | **Create** | Top bar with save/test/publish |
| `app/(pages)/workflows/editor/components/EditorSidebar.tsx` | **Create** | Left panel (AI chat/palette) |
| `app/(pages)/workflows/editor/components/EditorMain.tsx` | **Create** | Center area (list or canvas) |
| `app/(pages)/workflows/editor/components/EditorInspector.tsx` | **Create** | Right panel (details/config) |
| **Components - List View** |
| `app/(pages)/workflows/editor/components/list/StepTimeline.tsx` | **Create** | Timeline container |
| `app/(pages)/workflows/editor/components/list/StepCard.tsx` | **Create** | Collapsed step card |
| `app/(pages)/workflows/editor/components/list/StepCardExpanded.tsx` | **Create** | Expanded step details |
| `app/(pages)/workflows/editor/components/list/DataFlowIndicator.tsx` | **Create** | Arrow between steps |
| `app/(pages)/workflows/editor/components/list/AddStepButton.tsx` | **Create** | Add step placeholder |
| **Components - Canvas View** |
| `app/(pages)/workflows/editor/components/canvas/WorkflowCanvas.tsx` | **Create** | ReactFlow wrapper |
| `app/(pages)/workflows/editor/components/canvas/StepNode.tsx` | **Create** | Custom node component |
| `app/(pages)/workflows/editor/components/canvas/DataEdge.tsx` | **Create** | Custom edge component |
| **Components - Panels** |
| `app/(pages)/workflows/editor/components/panels/ToolPalette.tsx` | **Create** | Tool browser |
| `app/(pages)/workflows/editor/components/panels/ToolPaletteGroup.tsx` | **Create** | Toolkit group |
| `app/(pages)/workflows/editor/components/panels/ToolPaletteItem.tsx` | **Create** | Single tool item |
| `app/(pages)/workflows/editor/components/panels/InputsPanel.tsx` | **Create** | Runtime inputs config |
| `app/(pages)/workflows/editor/components/panels/ConfigPanel.tsx` | **Create** | Workflow configs |
| `app/(pages)/workflows/editor/components/panels/ConnectionsPanel.tsx` | **Create** | Required connections |
| `app/(pages)/workflows/editor/components/panels/TestPanel.tsx` | **Create** | Test execution UI |
| **Components - Inspector** |
| `app/(pages)/workflows/editor/components/inspector/StepInspector.tsx` | **Create** | Selected step details |
| `app/(pages)/workflows/editor/components/inspector/InputMappingSection.tsx` | **Create** | Input mapping UI |
| `app/(pages)/workflows/editor/components/inspector/OutputSchemaSection.tsx` | **Create** | Output display |
| `app/(pages)/workflows/editor/components/inspector/MappingDropdown.tsx` | **Create** | Source field selector |
| **Hooks** |
| `app/(pages)/workflows/editor/hooks/useComposioTools.ts` | **Create** | Fetch available tools |
| `app/(pages)/workflows/editor/hooks/usePersistence.ts` | **Create** | Auto-save logic |
| `app/(pages)/workflows/editor/hooks/useWorkflowExecution.ts` | **Create** | Test execution |

### 5.3 Files to Modify

| File | Action | Description |
|------|--------|-------------|
| `components/layout/TopNav.tsx` | **Modify** | Add "Workflows" nav item |
| `_tables/types.ts` | **Modify** | Add WorkflowDefinition type |

### 5.4 UX Mockups

| Mockup | Location | Description |
|--------|----------|-------------|
| List View (Primary) | `_docs/UXD/Pages/workflow/Flight A/variation-3/` | **Starting point** - Timeline/progressive disclosure |
| Panels-First | `_docs/UXD/Pages/workflow/Flight A/variation-1/` | Reference for canvas + tabbed panels |
| Timeline B | `_docs/UXD/Pages/workflow/Flight B/` | Alternative timeline approaches |

---

## 6. Implementation Phases

### Phase 1: Foundation & Navigation

**Goal:** Establish folder structure, types, and navigation entry point.

**Changes:**
1. Create `_tables/workflows/` folder with `.gitkeep`
2. Create `app/api/workflows/services/types.ts` with core type definitions
3. Create `app/(pages)/workflows/page.tsx` (empty list page)
4. Modify `components/layout/TopNav.tsx` to add "Workflows" nav item
5. Create basic CRUD API routes (create, list, get)

**File Impact:**

| File | Action |
|------|--------|
| `_tables/workflows/.gitkeep` | Create |
| `app/api/workflows/services/types.ts` | Create |
| `app/api/workflows/create/route.ts` | Create |
| `app/api/workflows/list/route.ts` | Create |
| `app/api/workflows/[workflowId]/route.ts` | Create |
| `app/api/workflows/services/storage.ts` | Create |
| `app/(pages)/workflows/page.tsx` | Create |
| `components/layout/TopNav.tsx` | Modify |

**Phase 1 Acceptance Criteria:**

| # | Criterion | Test Method |
|---|-----------|-------------|
| P1.1 | "Workflows" link visible in top nav | Visual check |
| P1.2 | Navigate to /workflows shows list page | Click link |
| P1.3 | "New Workflow" button creates workflow | Click → API creates folder |
| P1.4 | Workflow folders created in `_tables/workflows/` | Check filesystem |

**Phase 1 Test Flow:**
```
1. Start dev server (npm run dev)
2. Navigate to /home
3. Verify "Workflows" appears in top nav
4. Click "Workflows" → loads /workflows
5. Click "New Workflow" → API creates folder
6. Check _tables/workflows/[id]/ exists
```

---

### Phase 2: Editor Shell & Store

**Goal:** Create the editor page with 3-panel layout and Zustand store foundation.

**Changes:**
1. Create `app/(pages)/workflows/editor/page.tsx` with basic layout
2. Create `app/(pages)/workflows/editor/layout.tsx` 
3. Create Zustand store with steps slice
4. Create EditorHeader component
5. Create placeholder components for left/center/right panels

**File Impact:**

| File | Action |
|------|--------|
| `app/(pages)/workflows/editor/page.tsx` | Create |
| `app/(pages)/workflows/editor/layout.tsx` | Create |
| `app/(pages)/workflows/editor/store/index.ts` | Create |
| `app/(pages)/workflows/editor/store/types.ts` | Create |
| `app/(pages)/workflows/editor/store/slices/stepsSlice.ts` | Create |
| `app/(pages)/workflows/editor/components/EditorHeader.tsx` | Create |
| `app/(pages)/workflows/editor/components/EditorSidebar.tsx` | Create (placeholder) |
| `app/(pages)/workflows/editor/components/EditorMain.tsx` | Create (placeholder) |
| `app/(pages)/workflows/editor/components/EditorInspector.tsx` | Create (placeholder) |

**Phase 2 Acceptance Criteria:**

| # | Criterion | Test Method |
|---|-----------|-------------|
| P2.1 | Editor page loads at /workflows/editor | Navigate with ?id= |
| P2.2 | 3-panel layout renders | Left, center, right panels visible |
| P2.3 | Header shows workflow name | Editable title input |
| P2.4 | Store initializes with empty steps | Check store state |

---

### Phase 3: List View (Timeline)

**Goal:** Implement the primary list/timeline view based on Flight A Variation 3.

**Changes:**
1. Create StepTimeline component
2. Create StepCard (collapsed state)
3. Create StepCardExpanded
4. Create DataFlowIndicator
5. Create AddStepButton
6. Implement step selection in store

**File Impact:**

| File | Action |
|------|--------|
| `app/(pages)/workflows/editor/components/list/StepTimeline.tsx` | Create |
| `app/(pages)/workflows/editor/components/list/StepCard.tsx` | Create |
| `app/(pages)/workflows/editor/components/list/StepCardExpanded.tsx` | Create |
| `app/(pages)/workflows/editor/components/list/DataFlowIndicator.tsx` | Create |
| `app/(pages)/workflows/editor/components/list/AddStepButton.tsx` | Create |
| `app/(pages)/workflows/editor/store/slices/stepsSlice.ts` | Modify - add selection |

**Phase 3 Acceptance Criteria:**

| # | Criterion | Test Method |
|---|-----------|-------------|
| P3.1 | Empty state shows "Add a Step" prompt | Visual check |
| P3.2 | Steps render as timeline cards | Add mock step |
| P3.3 | Click step expands it | Click → see details |
| P3.4 | Data flow indicator between steps | Arrow visible |
| P3.5 | Steps can be reordered | Drag-drop |

---

### Phase 4: Tool Palette

**Goal:** Implement the tool browser with Composio integration.

**Changes:**
1. Create ToolPalette component
2. Create ToolPaletteGroup (toolkit grouping)
3. Create ToolPaletteItem
4. Create useComposioTools hook
5. Implement "add step" action

**File Impact:**

| File | Action |
|------|--------|
| `app/(pages)/workflows/editor/components/panels/ToolPalette.tsx` | Create |
| `app/(pages)/workflows/editor/components/panels/ToolPaletteGroup.tsx` | Create |
| `app/(pages)/workflows/editor/components/panels/ToolPaletteItem.tsx` | Create |
| `app/(pages)/workflows/editor/hooks/useComposioTools.ts` | Create |
| `app/(pages)/workflows/editor/store/slices/stepsSlice.ts` | Modify - addStep |

**Phase 4 Acceptance Criteria:**

| # | Criterion | Test Method |
|---|-----------|-------------|
| P4.1 | Palette shows connected integrations | Tools visible |
| P4.2 | Palette shows NO_AUTH tools | Browser, Firecrawl visible |
| P4.3 | Tools grouped by toolkit | Gmail, GitHub sections |
| P4.4 | Search filters tools | Type → results filter |
| P4.5 | Click tool adds step | Tool → step in timeline |

---

### Phase 5: Step Inspector (Right Panel)

**Goal:** Implement the inspector panel for viewing/editing selected step details.

**Changes:**
1. Create StepInspector component
2. Create InputMappingSection
3. Create OutputSchemaSection
4. Display input/output schemas from Composio tools
5. Integrate with selection state

**File Impact:**

| File | Action |
|------|--------|
| `app/(pages)/workflows/editor/components/inspector/StepInspector.tsx` | Create |
| `app/(pages)/workflows/editor/components/inspector/InputMappingSection.tsx` | Create |
| `app/(pages)/workflows/editor/components/inspector/OutputSchemaSection.tsx` | Create |
| `app/(pages)/workflows/editor/components/EditorInspector.tsx` | Modify |

**Phase 5 Acceptance Criteria:**

| # | Criterion | Test Method |
|---|-----------|-------------|
| P5.1 | Select step → inspector shows details | Click step |
| P5.2 | Input schema fields displayed | Fields visible |
| P5.3 | Output schema fields displayed | Fields visible |
| P5.4 | No selection → empty state | Clear selection |

---

### Phase 6: Data Mapping

**Goal:** Enable mapping outputs from previous steps to inputs of current step.

**Changes:**
1. Create MappingDropdown component
2. Create mappings slice in store
3. Implement mapping selection UI
4. Add type validation (warning indicators)
5. Handle nested field access

**File Impact:**

| File | Action |
|------|--------|
| `app/(pages)/workflows/editor/components/inspector/MappingDropdown.tsx` | Create |
| `app/(pages)/workflows/editor/store/slices/mappingsSlice.ts` | Create |
| `app/(pages)/workflows/editor/store/index.ts` | Modify - add mappings slice |
| `app/(pages)/workflows/editor/components/inspector/InputMappingSection.tsx` | Modify |

**Phase 6 Acceptance Criteria:**

| # | Criterion | Test Method |
|---|-----------|-------------|
| P6.1 | Dropdown shows available sources | Step outputs + inputs |
| P6.2 | Can select mapping | Select → saved to store |
| P6.3 | Mapping persists on selection | Reselect step → mapping shown |
| P6.4 | Type mismatch shows warning | string[] → string |
| P6.5 | Nested paths work | `data.user.email` |

---

### Phase 7: Runtime Inputs & Config

**Goal:** Allow users to define workflow inputs and configuration options.

**Changes:**
1. Create InputsPanel component
2. Create ConfigPanel component
3. Create inputs slice in store
4. Make inputs available in mapping dropdowns
5. Add $ prefix indicator for inputs

**File Impact:**

| File | Action |
|------|--------|
| `app/(pages)/workflows/editor/components/panels/InputsPanel.tsx` | Create |
| `app/(pages)/workflows/editor/components/panels/ConfigPanel.tsx` | Create |
| `app/(pages)/workflows/editor/store/slices/inputsSlice.ts` | Create |
| `app/(pages)/workflows/editor/store/index.ts` | Modify |
| `app/(pages)/workflows/editor/components/inspector/MappingDropdown.tsx` | Modify |

**Phase 7 Acceptance Criteria:**

| # | Criterion | Test Method |
|---|-----------|-------------|
| P7.1 | Can add runtime input | Click Add → input appears |
| P7.2 | Can set input type/description | Edit fields |
| P7.3 | Inputs appear in mapping dropdown | $inputName option |
| P7.4 | Can add config option | Click Add → config appears |
| P7.5 | Config has default value | Default field editable |

---

### Phase 8: Connections Panel

**Goal:** Auto-detect and display required connections for the workflow.

**Changes:**
1. Create ConnectionsPanel component
2. Derive required connections from step tools
3. Show connected/not-connected status
4. Link to connections page for missing

**File Impact:**

| File | Action |
|------|--------|
| `app/(pages)/workflows/editor/components/panels/ConnectionsPanel.tsx` | Create |
| `app/(pages)/workflows/editor/components/EditorInspector.tsx` | Modify - add tab |

**Phase 8 Acceptance Criteria:**

| # | Criterion | Test Method |
|---|-----------|-------------|
| P8.1 | Required connections auto-detected | Add Gmail tool → Gmail shown |
| P8.2 | Connected integrations show green | Green indicator |
| P8.3 | Missing connections show warning | Yellow with Connect button |
| P8.4 | NO_AUTH tools not listed | Browser tool doesn't require connection |

---

### Phase 9: Persistence & Code Generation

**Goal:** Save workflow state and generate Mastra TypeScript code.

**Changes:**
1. Create persistence slice in store
2. Create usePersistence hook (auto-save)
3. Create generator service (editor.json → workflow.ts)
4. Update storage service for both files
5. Add save/publish buttons functionality

**File Impact:**

| File | Action |
|------|--------|
| `app/(pages)/workflows/editor/store/slices/persistenceSlice.ts` | Create |
| `app/(pages)/workflows/editor/hooks/usePersistence.ts` | Create |
| `app/api/workflows/services/generator.ts` | Create |
| `app/api/workflows/services/storage.ts` | Modify |
| `app/api/workflows/[workflowId]/route.ts` | Modify - PATCH |

**Phase 9 Acceptance Criteria:**

| # | Criterion | Test Method |
|---|-----------|-------------|
| P9.1 | Save creates editor.json | Check file |
| P9.2 | Save generates workflow.ts | Check file |
| P9.3 | Generated code valid TypeScript | No syntax errors |
| P9.4 | Code uses createWorkflow, createStep | Inspect generated code |
| P9.5 | Auto-save on changes | Modified indicator |
| P9.6 | Load restores state | Reopen → same state |

---

### Phase 10: Test Execution

**Goal:** Enable running workflow tests with step-by-step progress.

**Changes:**
1. Create TestPanel component
2. Create testing slice in store
3. Create useWorkflowExecution hook
4. Create executor service (runtime execution)
5. Implement streaming progress updates
6. Add error display

**File Impact:**

| File | Action |
|------|--------|
| `app/(pages)/workflows/editor/components/panels/TestPanel.tsx` | Create |
| `app/(pages)/workflows/editor/store/slices/testingSlice.ts` | Create |
| `app/(pages)/workflows/editor/hooks/useWorkflowExecution.ts` | Create |
| `app/api/workflows/services/executor.ts` | Create |
| `app/api/workflows/[workflowId]/execute/route.ts` | Create |

**Phase 10 Acceptance Criteria:**

| # | Criterion | Test Method |
|---|-----------|-------------|
| P10.1 | Test form shows runtime inputs | Fill form |
| P10.2 | Run Test executes workflow | Click → execution starts |
| P10.3 | Step progress updates in real-time | Watch steps |
| P10.4 | Successful steps show green ✓ | Visual check |
| P10.5 | Failed steps show red ✗ + error | Cause failure |
| P10.6 | Can stop running test | Stop button |
| P10.7 | Missing connections block test | Error shown |

---

### Phase 11: Canvas View

**Goal:** Add alternative ReactFlow canvas view sharing same state.

**Changes:**
1. Create WorkflowCanvas component (ReactFlow)
2. Create StepNode custom node
3. Create DataEdge custom edge
4. Add view toggle to header
5. Sync canvas ↔ store state

**File Impact:**

| File | Action |
|------|--------|
| `app/(pages)/workflows/editor/components/canvas/WorkflowCanvas.tsx` | Create |
| `app/(pages)/workflows/editor/components/canvas/StepNode.tsx` | Create |
| `app/(pages)/workflows/editor/components/canvas/DataEdge.tsx` | Create |
| `app/(pages)/workflows/editor/components/EditorHeader.tsx` | Modify - view toggle |
| `app/(pages)/workflows/editor/components/EditorMain.tsx` | Modify - conditional |

**Phase 11 Acceptance Criteria:**

| # | Criterion | Test Method |
|---|-----------|-------------|
| P11.1 | View toggle visible in header | Visual check |
| P11.2 | Canvas view renders with ReactFlow | Toggle → canvas |
| P11.3 | Steps appear as nodes | Nodes match steps |
| P11.4 | Data flows appear as edges | Edges connect nodes |
| P11.5 | Edit in canvas → list updates | Change → check list |
| P11.6 | Edit in list → canvas updates | Change → check canvas |

---

### Phase 12: Polish & Integration

**Goal:** Final polish, edge cases, and backwards compatibility.

**Changes:**
1. Error boundary components
2. Loading states throughout
3. Empty states throughout
4. Keyboard shortcuts
5. Final styling pass

**Phase 12 Acceptance Criteria:**

| # | Criterion | Test Method |
|---|-----------|-------------|
| P12.1 | All acceptance criteria (Section 3) pass | Full test suite |
| P12.2 | No console errors | DevTools check |
| P12.3 | Graceful error handling | Cause errors → handled |
| P12.4 | Responsive layout | Resize window |
| P12.5 | Existing features unaffected | Regression test |

---

## 7. Design Decisions

| Decision | Choice | Rationale |
|----------|--------|-----------|
| File naming | `editor.json` + `workflow.ts` | Distinct names for clarity (not both `workflow.*`) |
| Start with list view | Flight A V3 | More approachable progressive disclosure |
| Both views from start | List + Canvas | Core requirement; shared state from day 1 |
| Hybrid code gen | Runtime test, codegen prod | Fast iteration + reliable production |
| Granular phases | 12 phases | Each phase has clear theme + acceptance criteria |
| Direct mapping MVP | No transforms v1 | Simplicity; code nodes handle transforms |
| Connection IDs | Per-workflow | Baked into generated code, not runtime |

---

## 8. Out of Scope

- Workflow marketplace (future)
- Workflows calling other workflows (future)
- Loop/parallel control flow nodes (future)
- Wait/human-in-loop nodes (future)
- Test case saving/management (future phase)
- Workflow forking/copying (future)
- WebContainer execution (explicitly avoided)

---

## 9. References

- **Product Spec:** `15-workflow-editor.md`
- **Research (Parallel 1):** `15.1-workflow-research.md`
- **Research (Parallel 2):** `15.2-workflow-research.md`
- **Other Implementation:** `15.3-workflow-implementation.md`
- **Mastra Primitives:** `_docs/Engineering/Integrations/API Docs/Mastra/Workflow-Primitives.md`
- **UXD Mockups:** `_docs/UXD/Pages/workflow/`
- **Existing Tool Pattern:** `_tables/tools/hohoho/`

---

## 10. Completed Work

*Track progress as implementation proceeds.*

### Phase 0: Research ✅

**Issue:** Needed to understand Mastra workflow primitives and Composio schema availability.

**Fix:** Completed comprehensive research in 15.1 and 15.2, verified all APIs via source code inspection and live queries.

**Status:** Complete (Dec 6, 2025)

### Phase 0: UXD Mockups ✅

**Issue:** Needed visual designs before implementation.

**Fix:** Created Flight A and Flight B mockups with 3 variations each.

**Status:** Complete (Dec 6, 2025)

---

## Notes

- The `@composio/mastra` package is incompatible with current `@mastra/core@0.24.6`. Use manual tool wrapping as documented in existing `composio-tools.ts`.
- Composio's `outputParameters` field uses camelCase when accessed via `getRawComposioTools()`.
- Terminal nodes (e.g., Send Email) don't need output schema validation.
- Storage pattern: `_tables/workflows/[id]/editor.json` + `_tables/workflows/[id]/workflow.ts`




